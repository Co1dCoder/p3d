(function(){var e,t,r,n,i,s,o,a,c,h,l,u,f,p,v,d,g,m,y,_,w=this,b=function(e,t){return function(){return e.apply(t,arguments)}};for(i=!0,p=function(e,t){return e.slice(0,+(t.length-1)+1||9e9)===t},s=function(e,t){var r,n,i,s,o;for(o=e.split(/\r?\n/),r=i=0,s=o.length;s>i;r=++i)n=o[r],t(n,r);return void 0},r=function(e){return""+e[0].toUpperCase()+e.slice(1)},f=function(e){return e>0?1:0>e?-1:0},o=function(e){return e.split(".").pop()},e=function(e,t){var r;return r=new XMLHttpRequest,r.open("GET",e.url,!0),r.responseType="blob",null!=t&&(r.onload=function(){return t(r.response)}),r.send(),r},l=function(e){var t;return self.DOMParser?(new DOMParser).parseFromString(e,"text/xml"):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,xml.loadXML(e))},a=function(e,t,r){var n,i,s,o;for(n=[[2*Math.pow(e,3)-3*Math.pow(e,2)+1,Math.pow(e,3)-2*Math.pow(e,2)+e],[-2*Math.pow(e,3)+3*Math.pow(e,2),Math.pow(e,3)-Math.pow(e,2)]],o=[],i=s=0;2>=s;i=++s)o.push(t[0][i]*n[0][0]+r[0][i]*n[0][1]+t[1][i]*n[1][0]+r[1][i]*n[1][1]);return o},t=function(e){var t,r,n,i,s,o,a,c,h,l,u,f,p,v;if(r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=void 0,u=void 0,f=void 0,s=void 0,o=void 0,a=void 0,c=void 0,n=void 0,h=0,t=0,i="",v=[],!e)return e;for(;;)if(l=e.charCodeAt(h++),u=e.charCodeAt(h++),f=e.charCodeAt(h++),n=l<<16|u<<8|f,s=63&n>>18,o=63&n>>12,a=63&n>>6,c=63&n,v[t++]=r.charAt(s)+r.charAt(o)+r.charAt(a)+r.charAt(c),!(e.length>h))break;return i=v.join(""),p=e.length%3,(p?i.slice(0,p-3):i)+"===".slice(p||3)},c=void 0===self.document,v=["normals","vertices","indices","nOfTriangles","chunks"],c?(u=null,n=null,this.onmessage=function(e){var t,r,n,i,s,o,a,c,h,l,u,f,p;for(i=new P3D.Parser(e.data),n={},o=0,h=v.length;h>o;o++)r=v[o],n[r]=i[r];for(s=function(){var e,t,n,s;for(n=["normals","vertices","indices"],s=[],e=0,t=n.length;t>e;e++)r=n[e],s.push(i[r].buffer);return s}(),f=i.chunks,a=0,l=f.length;l>a;a++)for(t=f[a],p=["normals","vertices","indices"],c=0,u=p.length;u>c;c++)r=p[c],s.push(t[r].buffer);return postMessage(n,s)}):(d=arguments.callee,g=function(){var e,t;return null!=w.webWorkerURL?w.webWorkerURL:(e=""+d,e=e.replace(/^\s*function\s*\(\) {/,"").replace(/}\s*$/,""),t=new Blob([e],{type:"text/javascript"}),w.webWorkerURL=(window.URL||window.webkiURL).createObjectURL(t))}),self.P3D=function(){function t(t){this._onReaderLoad=b(this._onReaderLoad,this);var n,i=this;if(this.src=t,n=arguments,this.opts=n.length>2?n[1]:{background:!0},this.callback=n[n.length-1],this.filename="string"==typeof this.src?this.src.split("/").pop().replace("/",""):this.src.name,this.fileType=r(o(this.filename).toLowerCase()),-1===this._fileTypeWhitelist.indexOf(this.fileType))throw"Unable to parse file extension or unsupported file extension: "+this.fileType;"Amf"===this.fileType&&(this.opts.background=!1),"string"==typeof this.src?e({url:this.src},function(e){return i._initReader("Text",e)}):this._initReader("Text",this.src)}return t.prototype._fileTypeWhitelist=["Stl","Amf","Obj"],t.prototype._initReader=function(e,t){var r;return this.dataType=e,this.blob=t,r=this.reader=new FileReader,r.onload=this._onReaderLoad,r["readAs"+e](t)},t.prototype._binaryStlCheck=function(e){return"Stl"===this.fileType&&"Text"===this.dataType&&null===e.slice(0,81).match(/^solid /)},t.prototype._onReaderLoad=function(){return n=this.reader.result,delete this.reader,this._binaryStlCheck(n)?this._initReader("ArrayBuffer",this.blob):(delete this.blob,this._parse(n))},t.prototype._dataTypeInfo=function(){return"Text"===this.dataType?"Text":"Binary"},t.prototype._parsingDebugMsg=function(e){var t,r;return i?(e===!0?(t=((new Date).getTime()-this._parserStartMs)/1e3,r="[ DONE "+t+"s ]"):(this._parserStartMs=(new Date).getTime(),r=""),console.log("Parsing "+this.filename+" as "+this._dataTypeInfo().toLowerCase()+" "+this.fileType.toUpperCase()+".. "+r)):void 0},t.prototype._parse=function(e){var r,n,i=this;return this._parsingDebugMsg(!1),r={pipeline:["_parse"+this.dataType+this.fileType,"split"],data:e},this.opts.background===!0?(console.log("Running as a background job"),n=new Worker(g()),n.onmessage=function(e){return i._onParsingComplete(e.data)},n.addEventListener("error",function(e){return console.log(e)},!1),n.postMessage=n.webkitPostMessage||n.postMessage,n.postMessage(r,"Text"===this.dataType?[]:[e])):this._onParsingComplete(new t.Parser(r))},t.prototype._onParsingComplete=function(e){var t,r,n;for(r=0,n=v.length;n>r;r++)t=v[r],this[t]=e[t];return this.verts=this.vertices,this._parsingDebugMsg(!0),this.callback(this)},t.prototype.exportTextStl=function(){var e,t,r;return r="solid P3D\n",e=function(e,t){return(f(e)>=0||0===t?" ":"")+e.toExponential(6)},t=function(t,r){var n;return function(){var i,s;for(s=[],n=i=0;2>=i;n=++i)s.push(e(t[n],r?n:1));return s}().join(" ")},this._eachFace(function(e){var n,i,s,o;for(r+="  facet normal "+t(e.normals[0],!1)+"\n",r+="    outer loop\n",o=e.vertices,i=0,s=o.length;s>i;i++)n=o[i],r+="      vertex "+t(n,!0)+"\n";return r+="    endloop\n",r+="  endfacet\n"}),r+="endsolid P3D",r=r.replace(/e\+([0-9][^0-9])/g,"e+0$1"),r=r.replace(/e\-([0-9][^0-9])/g,"e-0$1"),new Blob([r],{type:"application/octet-stream"})},t}(),self.P3D.Parser=function(){function e(e){this.split=b(this.split,this),this._eachFace=b(this._eachFace,this);var t,r,n,i;for(this[e.pipeline[0]](e.data),i=e.pipeline.slice(1),r=0,n=i.length;n>r;r++)t=i[r],this[t]()}return e.prototype._toMillimeters=function(e){var t,r;if(t={mm:1,millimeter:1,meter:1e3,inch:25.4,feet:304.8,micron:.001},r=t[e.toLowerCase()],null!=r)return r;throw""+e+" is not a known unit of measurement"},e.prototype._initGeometry=function(e,t){var r,n,i,s;if(this.nOfTriangles=e,this.normals=new Float32Array(9*this.nOfTriangles),this.vertices=this.verts=new Float32Array(9*this.nOfTriangles),null!=t)this.indices=new Uint32Array(t);else for(n=this.indices=new Uint32Array(3*this.nOfTriangles),r=i=0,s=n.length;s>=0?s>=i:i>=s;r=s>=0?++i:--i)n[r]=r;return[this.normals,this.verts,this.indices]},e.prototype._addFace=function(e,t,r){var n,i,s,o,a,c,h;for(c=["vertices","normals"],h=[],o=0,a=c.length;a>o;o++)n=c[o],h.push(function(){var o,a;for(a=[],s=o=0;2>=o;s=++o)a.push(function(){var o,a;for(a=[],i=o=0;2>=o;i=++o)a.push(t[n][r+3*i+s]=e[n][i][s]);return a}());return a}());return h},e.prototype._expandVerts=function(){var e,t,r,n,i,s,o,a,c,h,l,u=this;for(this.nOfTriangles=this.indices.length/3,t={},c=["vertices","normals"],n=0,o=c.length;o>n;n++)e=c[n],t[e]=new Float32Array(9*this.nOfTriangles);for(this._eachFace(function(e,r){return u._addFace(e,t,9*r)}),r=i=0,h=this.indices.length-1;h>=0?h>=i:i>=h;r=h>=0?++i:--i)this.indices[r]=r;for(l=["vertices","normals"],s=0,a=l.length;a>s;s++)e=l[s],this[e]=t[e];return this.verts=this.vertices},e.prototype._parseTextAmf=function(e){var t,r,n,i,s,o,c,h,u,f,p,v,d,g,m,y,_,w,b,T,x,M,F,A,L,P,O,k,R,D,E,N,C,U=this;for(F=l(e),m=F.documentElement,A=function(e){return F.evaluate(e,F,null,XPathResult.ANY_TYPE,null)},g=function(e,t){return e.getElementsByTagName(t)[0].textContent},t=function(e,t){var r,n;for(n=A(e);null!=(r=n.iterateNext());)t(r);return void 0},T=m.getAttribute("unit")||m.getAttribute("units"),y=this._toMillimeters(T),x=0,o=0,f=A("count(//triangle)").numberValue,p=A("count(//vertex)").numberValue,D=this._initGeometry(p,3*f),d=D[0],M=D[1],c=D[2],t("//vertex",function(e){var t,r,n,i,s,o,a,c,h;for(t=e.getElementsByTagName("coordinates")[0],s=e.getElementsByTagName("normal"),1===s.length&&(i=function(){var e,t,i,o;for(i=["nx","ny","nz"],o=[],r=e=0,t=i.length;t>e;r=++e)n=i[r],o.push(d[x+r]=parseFloat(g(s[0],n)));return o}()),c=["x","y","z"],h=[],o=0,a=c.length;a>o;o++)n=c[o],h.push(M[x++]=parseFloat(g(t,n))*y);return h}),t("//triangle",function(e){var t,r,n;for(n=[],t=r=1;3>=r;t=++r)n.push(c[o++]=parseInt(g(e,"v"+t)));return n}),h=function(e){var t,r;return(t=e.normals)[0]===(r=t[1])&&r===t[2]},n=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},u=function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2))},v=function(e){var t,r,n,i;for(r=u(e),i=[],t=n=0;2>=n;t=++n)i.push(e[t]=e[t]/r);return i},this._expandVerts(),f=this.nOfTriangles,this._eachFace(this._calculateVertexNormals),w=4,b=Math.pow(4,w),this._eachFace(function(e){return h(e)?void 0:f+=b-1}),i={},E=["vertices","normals"],L=0,k=E.length;k>L;L++)r=E[L],i[r]=new Float32Array(9*f);for(x=0,_=function(e,t){var r,i,s,o,c,h,l,f,p,d,g,m,y,_,w,b;for(l=[],h=[],b=[[0,1],[1,2],[2,0]],_=0,w=b.length;w>_;_++)s=b[_],m=[e.vertices[s[0]],e.vertices[s[1]]],f=[e.normals[s[0]],e.normals[s[1]]],i=function(){var e,t;for(t=[],o=e=0;2>=e;o=++e)t.push(m[1][o]-m[0][o]);return t}(),g=function(){var e,t;for(t=[],o=e=0;1>=e;o=++e)r=n(n(f[o],i),f[o]),t.push(function(){var e,t;for(t=[],c=e=0;2>=e;c=++e)t.push(u(i)*r[c]/u(r));return t}());return t}(),l.push(y=a(.5,m,g,t)),h.push(p=v(function(){var e,t;for(t=[],o=e=0;2>=e;o=++e)t.push((f[1][o]+f[0][o])/2);return t}()));return d=function(){var t,r;for(r=[],o=t=0;2>=t;o=++t)r.push({vertices:[l[o],l[c=(o+2)%3],e.vertices[o]],normals:[h[o],h[c],e.normals[o]]});return r}(),d.push({vertices:l,normals:h}),d},this._eachFace(function(e,t){var n,s,o,a,c,l,u,f,p,v,d,g,m,y,b,T,M,F,A,L,P,O;if(h(e)){for(A=["vertices","normals"],f=0,d=A.length;d>f;f++)for(r=A[f],l=p=0;2>=p;l=++p)for(c=v=0;2>=v;c=++v)i[r][x+3*c+l]=e[r][c][l];return x+=9}for(o=[e],u=[],a=b=0,L=w-1;L>=0?L>=b:b>=L;a=L>=0?++b:--b){for(u=[],T=0,g=o.length;g>T;T++)for(n=o[T],P=_(n,t+Math.pow(4,a)),M=0,m=P.length;m>M;M++)s=P[M],u.push(s);o=u}for(O=[],F=0,y=u.length;y>F;F++)n=u[F],U._addFace(n,i,x),O.push(x+=9);return O}),c=this.indices=new Float32Array(3*f),s=P=0,N=this.indices.length-1;N>=0?N>=P:P>=N;s=N>=0?++P:--P)this.indices[s]=s;for(C=["vertices","normals"],O=0,R=C.length;R>O;O++)r=C[O],this[r]=i[r];return this.verts=this.vertices,this.nOfTriangles=f,this._eachFace(this._calculateVertexNormals),this.nOfTriangles=f,void 0},e.prototype._parseEachLine=function(e,t,r,n){var i,o;return o=0,i=function(t){return s(e,function(e,n){return n>=r.headerLines?t(e,n):void 0})},i(function(e){return-1!==e.indexOf(t.face)?o++:void 0}),this._initGeometry(o),i(function(e,t){return e=e.replace(/^\s+|\s+$/g,"").replace(/\s{2,}/g," ").toLowerCase(),n(e,t)}),void 0},e.prototype._parseTextObj=function(e){var t,r,n,i=this;return r={normal:"vn ",vert:"v ",face:"f "},t=0,n=0,this._parseEachLine(e,r,{headerLines:0},function(e){var s,o,a,c,h,l,u,f,v,d;if(p(e,r.vert)){if(c=e.split(/\s/).slice(1),3>c.length)throw"Parsing Error: "+c.length+" vector vertex";for(v=c.slice(0,3),h=0,u=v.length;u>h;h++)if(s=v[h],i.vertices[n++]=a=parseFloat(s),isNaN(a)||!isFinite(a))throw"Parsing Error: Vertex vector #"+n+" is not a number"}else if(p(e,r.face))for(d=e.split(/\s/).slice(1),l=0,f=d.length;f>l;l++)o=d[l],i.indices[t++]=parseInt(o.split("/")[0])-1;return void 0}),this._expandVerts(),this._eachFace(this._calculateVertexNormals),void 0},e.prototype._parseTextStl=function(e){var t,r,n,i,s=this;return n={normal:"facet normal ",vert:"vertex ",face:"facet"},t=["outer","endloop","facet","endfacet","endsolid"],r=0,i=0,this._parseEachLine(e,n,{headerLines:1},function(e){var r,o,a,c,h,l;if(p(e,n.vert)){if(c=e.split(/\s/).slice(1),3!==c.length)throw"Parsing Error: "+c.length+" vector vertex";for(h=0,l=c.length;l>h;h++)if(o=c[h],s.vertices[i++]=a=parseFloat(o),isNaN(a)||!isFinite(a))throw"Parsing Error: Vertex vector #"+i+" is not a number"}else if(e.length>0){if(function(){var n,i,s;for(s=[],n=0,i=t.length;i>n;n++)r=t[n],s.push(p(e,r));return s}())return;throw"Parsing Error: Invalid Line \n "+e}return void 0}),this._eachFace(this._calculateVertexNormals),void 0},e.prototype._parseArrayBufferStl=function(e){var t,r,i,s,o,a,c,h,l,u,f,p,v,d,g,m;for(n=new DataView(e,80),t=0,d=function(e,r){var i;return i=n[e](t,!0),t+=r,i},c=function(){return d("getFloat32",4)},l=function(){return d("getUint32",4)},h=function(){return d("getUint16",2)},o=l(),g=this._initGeometry(o),a=g[0],u=g[1],i=g[2],r=f=0,m=o-1;m>=0?m>=f:f>=m;r=m>=0?++f:--f){for(s=p=0;2>=p;s=++p)c();for(s=v=0;8>=v;s=++v)u[9*r+s]=c();h()}return this._eachFace(this._calculateVertexNormals),void 0},e.prototype._eachFace=function(e){var t,r,n,i;for(r=this.indices,t=n=0,i=this.indices.length-3;i>=n;t=n+=3)e(this._face(r.subarray(t,t+3)),t/3);return void 0},e.prototype._face=function(e){var t;return{indices:e,normals:function(){var r,n,i;for(i=[],r=0,n=e.length;n>r;r++)t=e[r],i.push(this.normals.subarray(3*t,3*t+3));return i}.call(this),vertices:function(){var r,n,i;for(i=[],r=0,n=e.length;n>r;r++)t=e[r],i.push(this.vertices.subarray(3*t,3*t+3));return i}.call(this)}},e.prototype._flipFace=function(e){var t;return t=e.indices[0],e.indices[0]=e.indices[1],e.indices[1]=t},e.prototype._calculateVertexNormals=function(e){var t,r,n,i,s,o,a,c;for(i=function(){var n,i;for(i=[],t=n=1;2>=n;t=++n)i.push(function(){var n,i;for(i=[],r=n=0;2>=n;r=++n)i.push(e.vertices[t][r]-e.vertices[0][r]);return i}());return i}(),s=[i[0][1]*i[1][2]-i[0][2]*i[1][1],i[0][2]*i[1][0]-i[0][0]*i[1][2],i[0][0]*i[1][1]-i[0][1]*i[1][0]],n=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]),t=o=0;2>=o;t=++o)s[t]=s[t]/n;for(c=[],t=a=0;2>=a;t=++a)0===e.normals[t][0]&&0===e.normals[t][1]&&0===e.normals[t][2]?c.push(function(){var n,i;for(i=[],r=n=0;2>=n;r=++n)i.push(e.normals[t][r]=s[r]);return i}()):c.push(void 0);return c},e.prototype.split=function(){var e,t,r,n,i,s,o,a;return e=Math.pow(2,16),e-=e%9,this.chunks=function(){var c,h,l,u,f,p,v,d,g,m,y;for(y=[],a=c=0,d=this.indices.length-1;d>=0?d>=c:c>=d;a=c+=e){for(s=this.indices.subarray(a,a+e),o={indices:new Uint16Array(s.length),vertices:[],normals:[]},t=h=0,g=o.indices.length-1;g>=0?g>=h:h>=g;t=g>=0?++h:--h)o.indices[t]=t;for(n=l=0,f=s.length;f>l;n=++l)for(i=s[n],r=u=0;2>=u;r=++u)o.vertices[3*n+r]=this.vertices[3*i+r],o.normals[3*n+r]=this.normals[3*i+r];for(m=["vertices","normals"],v=0,p=m.length;p>v;v++)r=m[v],o[r]=new Float32Array(o[r]);y.push(o)}return y}.call(this)},e}(),_=["_eachFace","_face"],m=0,y=_.length;y>m;m++)h=_[m],P3D.prototype[h]=P3D.Parser.prototype[h]}).call(this);